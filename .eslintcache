[{"/Users/dmitry/projects/serverless/bulkUpload/src/handler.ts":"1","/Users/dmitry/projects/serverless/bulkUpload/src/s3Handler.ts":"2","/Users/dmitry/projects/serverless/bulkUpload/tests/example.test.ts":"3","/Users/dmitry/projects/serverless/pdf2img/tests/example.test.ts":"4","/Users/dmitry/projects/serverless/pdf2img/src/convert.ts":"5","/Users/dmitry/projects/serverless/pdf2img/src/split.ts":"6","/Users/dmitry/projects/serverless/childAssets/src/handler.ts":"7"},{"size":1653,"mtime":1592563623343,"results":"8","hashOfConfig":"9"},{"size":1285,"mtime":1592563443086,"results":"10","hashOfConfig":"9"},{"size":133,"mtime":1592507928797,"results":"11","hashOfConfig":"9"},{"size":133,"mtime":1592507928797,"results":"12","hashOfConfig":"13"},{"size":2172,"mtime":1593456501703,"results":"14","hashOfConfig":"13"},{"size":2232,"mtime":1593457433988,"results":"15","hashOfConfig":"13"},{"size":7193,"mtime":1594036430164,"results":"16","hashOfConfig":"17"},{"filePath":"18","messages":"19","errorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0},"11xtwve",{"filePath":"20","messages":"21","errorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0},{"filePath":"22","messages":"23","errorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0},{"filePath":"24","messages":"25","errorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0},"cg2gys",{"filePath":"26","messages":"27","errorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0},{"filePath":"28","messages":"29","errorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0},{"filePath":"30","messages":"31","errorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"32"},"17vr2nx","/Users/dmitry/projects/serverless/bulkUpload/src/handler.ts",[],"/Users/dmitry/projects/serverless/bulkUpload/src/s3Handler.ts",[],"/Users/dmitry/projects/serverless/bulkUpload/tests/example.test.ts",[],"/Users/dmitry/projects/serverless/pdf2img/tests/example.test.ts",[],"/Users/dmitry/projects/serverless/pdf2img/src/convert.ts",[],"/Users/dmitry/projects/serverless/pdf2img/src/split.ts",[],"/Users/dmitry/projects/serverless/childAssets/src/handler.ts",["33","34"],"import { APIGatewayProxyHandler, APIGatewayProxyEvent } from \"aws-lambda\";\nimport fetch, { Response } from \"node-fetch\";\nimport { JSONPath } from \"jsonpath-plus\";\nimport { parse } from \"node-html-parser\";\n\n// const obj = {\n//   test: 123,\n//   test2: {\n//     qwe: 3,\n//   },\n// };\n\nfunction getHtmlByAssetType(assetType: string, assetJSON: AssetJSON) {\n  switch (assetType) {\n    case \"LandingPage\":\n      return assetJSON.htmlContent.html || assetJSON.htmlContent.htmlBody;\n      break;\n    case \"SharedContent\":\n      return assetJSON.contentHtml.html || assetJSON.contentHtml.htmlBody;\n      break;\n    case \"EmailHeader\":\n    case \"EmailFooter\":\n      return assetJSON.body;\n      break;\n    case \"DynamicContent\":\n      return (\n        assetJSON.defaultContentSection?.contentHtml?.html ||\n        assetJSON.defaultContentSection?.contentHtml.htmlBody\n      );\n      break;\n    default:\n      return null;\n      break;\n  }\n}\n\nfunction findNode(object: Record<string, any>, key: string) {\n  let value: string;\n  Object.keys(object).some((k: string) => {\n    if (k === key) {\n      value = object[k];\n      return true;\n    }\n    if (object[k] && typeof object[k] === \"object\") {\n      value = findNode(object[k], key);\n      return value !== undefined;\n    }\n    return false;\n  });\n  return value;\n}\n\nfunction getAssetsIdByJSONPath(\n  json: AssetJSON | Array<any>,\n  expression: string,\n  nodeValue: string\n) {\n  const assetsId = [];\n  const assets = JSONPath({ path: expression, json });\n  assets.forEach((el: Node | string) => {\n    if (typeof el === \"string\" || typeof el === \"number\") {\n      assetsId.push(el);\n    } else if (typeof el === \"object\") {\n      // console.log(el, nodeValue);\n      if (el.id && findNode(el, nodeValue))\n        assetsId.push(findNode(el, nodeValue));\n    }\n  });\n  return assetsId;\n}\n\nexport const index: APIGatewayProxyHandler = async (\n  event: APIGatewayProxyEvent\n) => {\n  const promises: Promise<void>[] = [];\n  const body: Body = JSON.parse(event.body);\n  const finalResult = [];\n\n  const response = await fetch(\n    `http://apps.portqii.com:8070/getChilAssetConfigurationsByAssetType?AssetType=${body.assetType}`\n  );\n  const childAssetsConfiguration: childAssetsConfiguration[] = await response.json();\n  // console.log(childAssetsConfiguration);\n\n  for (const item of childAssetsConfiguration) {\n    item.JSON_Node_Value = item.JSON_Node_Value.trim();\n    let childAssetIdArray = [];\n    if (item.JSON_Node_Type_In_Parent === 0) {\n      if (body.assetType === \"Form\" && !item.JSONPath_Expression) {\n        childAssetIdArray = getAssetsIdByJSONPath(\n          [...body.assetJSON.elements, ...body.assetJSON.processingSteps],\n          `$..${item.JSON_Node_Value}`,\n          item.JSON_Node_Value\n        );\n        // console.log(item.JSON_Node_Value, childAssetIdArray);\n      } else if (item.JSONPath_Expression) {\n        childAssetIdArray = getAssetsIdByJSONPath(\n          body.assetJSON,\n          item.JSONPath_Expression,\n          item.JSON_Node_Value\n        );\n      } else {\n        childAssetIdArray = getAssetsIdByJSONPath(\n          body.assetJSON,\n          `$..${item.JSON_Node_Value}`,\n          item.JSON_Node_Value\n        );\n      }\n    } else {\n      childAssetIdArray = getAssetsIdByJSONPath(\n        body.assetJSON,\n        item.JSONPath_Expression || item.JSON_Node_Value,\n        item.JSON_Node_Value\n      );\n    }\n\n    // console.log(\n    //   item.JSON_Node_Type_In_Parent\n    //     ? item.JSONPath_Expression || item.JSON_Node_Value\n    //     : `$..${item.JSON_Node_Value}`,\n    //   getAssetsIdByJSONPath(\n    //     body.assetJSON,\n    //     item.JSON_Node_Type_In_Parent\n    //       ? item.JSONPath_Expression || item.JSON_Node_Value\n    //       : `$..${item.JSON_Node_Value}`,\n    //     item.JSON_Node_Value\n    //   )\n    // );\n\n    if (childAssetIdArray.length) {\n      promises.push(\n        fetch(`\n        http://apps.portqii.com:8070/getChildAssetEndPointsByJSON_Node_TypeAndJSON_Node_Value?JSON_Node_Value=${item.JSON_Node_Value}&JSON_Node_Type=${item.JSON_Node_Type}\n      `).then(async (r: Response) => {\n          const endpoints: Endpoint[] = await r.json();\n          if (endpoints.length) {\n            const result = await (\n              await fetch(\n                `http://apps.portqii.com:8070/getAssetTypeByEndpointUrl?Endpoint_URL=${encodeURIComponent(\n                  endpoints[0].Endpoint_URL\n                )}&JSON_Node_Value=${item.JSON_Node_Value}`\n              )\n            ).json();\n            const assetData = result[0];\n            if (assetData) {\n              childAssetIdArray.forEach((childAsset) => {\n                finalResult.push({\n                  childAssetType: assetData.Asset_Type,\n                  childAssetId: childAsset,\n                  nodeValue: item.JSON_Node_Value,\n                  jsonPath: item.JSONPath_Expression,\n                });\n              });\n            }\n          }\n        })\n      );\n    }\n  }\n  await Promise.all(promises);\n\n  const trimmedAssetType = body.assetType.replace(\" \", \"\");\n\n  if (\n    trimmedAssetType === \"LandingPage\" ||\n    trimmedAssetType === \"SharedContent\" ||\n    trimmedAssetType === \"DynamicContent\" ||\n    trimmedAssetType === \"EmailFooter\" ||\n    trimmedAssetType === \"EmailHeader\"\n  ) {\n    // const { html, htmlBody } =\n    //   body.assetJSON.htmlContent ||\n    //   body.assetJSON.contentHtml ||\n    //   body.assetJSON.body ||\n    //   body.assetJSON.defaultContentSection?.contentHtml ||\n    //   {};\n    // const data = html || htmlBody;\n    const data = getHtmlByAssetType(trimmedAssetType, body.assetJSON);\n    if (data) {\n      const doc = parse(data);\n      const result = doc.querySelectorAll(\".eloquaemail\");\n      result.forEach((item) => {\n        finalResult.push({\n          childAssetType: \"Field Merge\",\n          childAssetName: item.innerHTML,\n          nodeValue: \"id\",\n          jsonPath: \"\",\n        });\n      });\n    }\n  }\n\n  if (body.assetType === \"Email\" || body.assetType === \"email\") {\n    const doc = parse(body.assetJSON.plainText);\n    const result = doc.querySelectorAll(\"[layoutid]\");\n    result.forEach((item) => {\n      finalResult.push({\n        childAssetType: \"Signature Layout\",\n        childAssetId: item.getAttribute(\"layoutid\"),\n        nodeValue: \"email_signatureLayout\",\n        jsonPath: \"\",\n      });\n    });\n  }\n\n  return {\n    statusCode: 200,\n    body: JSON.stringify(finalResult),\n    // body: JSON.stringify(childAssetsConfiguration),\n  };\n};\n\ninterface Endpoint {\n  Endpoint_URL: string;\n  Depth: string;\n}\n\ninterface Body {\n  assetType: string;\n  assetJSON: AssetJSON;\n}\n\ninterface AssetJSON {\n  elements: [];\n  processingSteps: [];\n  htmlContent: {\n    html: string;\n    htmlBody: string;\n    // contentHtml: string;\n    // body: string;\n  };\n  contentHtml: {\n    html: string;\n    htmlBody: string;\n  };\n  defaultContentSection: {\n    contentHtml: {\n      html: string;\n      htmlBody: string;\n    };\n  };\n  body: string;\n  plainText: string;\n}\n\ninterface childAssetsConfiguration {\n  JSON_Node_Type_In_Parent: number;\n  JSONPath_Expression: string;\n  JSON_Node_Value: string;\n  JSON_Node_Type: string;\n}\n\ninterface Node {\n  id: string;\n}\n",{"ruleId":"35","severity":1,"message":"36","line":37,"column":42,"nodeType":"37","messageId":"38","endLine":37,"endColumn":45,"suggestions":"39"},{"ruleId":"35","severity":1,"message":"36","line":54,"column":27,"nodeType":"37","messageId":"38","endLine":54,"endColumn":30,"suggestions":"40"},"@typescript-eslint/no-explicit-any","Unexpected any. Specify a different type.","TSAnyKeyword","unexpectedAny",["41","42"],["43","44"],{"messageId":"45","fix":"46","desc":"47"},{"messageId":"48","fix":"49","desc":"50"},{"messageId":"45","fix":"51","desc":"47"},{"messageId":"48","fix":"52","desc":"50"},"suggestUnknown",{"range":"53","text":"54"},"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct.","suggestNever",{"range":"53","text":"55"},"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of.",{"range":"56","text":"54"},{"range":"56","text":"55"},[974,977],"unknown","never",[1366,1369]]